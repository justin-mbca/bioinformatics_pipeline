name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q
      - name: Integrator runtime summary (example)
        run: |
          python3 workflows_local/integrate_genomics_clinical.py rna_seq/annotated_results.csv clinical/analysis_results.csv docs/report_example.csv --markers scrna_seq/results/markers.csv --mapping workflows_local/gene_mapping_example.csv || true
      - name: Snakemake dry-run
        run: |
          pip install snakemake
          snakemake --snakefile workflows_local/Snakefile -n

  r-integration:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - name: Run R-enabled integration in Docker
        run: |
          docker pull rocker/verse:4.2.2
          docker run --rm -v ${{ github.workspace }}:/work -w /work rocker/verse:4.2.2 bash -lc "
            apt-get update && apt-get install -y python3 python3-pip git && \
            python3 -m pip install --upgrade pip && \
            pip3 install snakemake pandas && \
            Rscript -e 'if (!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager", repos="https://cloud.r-project.org"); BiocManager::install("DESeq2", ask=FALSE)' && \
            python3 workflows_local/integrate_genomics_clinical.py rna_seq/annotated_results.csv clinical/analysis_results.csv docs/report_example.csv --markers scrna_seq/results/markers.csv --mapping workflows_local/gene_mapping_example.csv || true && \
            snakemake --snakefile workflows_local/Snakefile -n"
